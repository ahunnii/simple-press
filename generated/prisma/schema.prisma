// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

enum ROLE {
  ADMIN
  USER
  OWNER
}

// Necessary for Better Auth

model User {
  id            String    @id @default(cuid())
  name          String //@db.Text
  email         String
  emailVerified Boolean   @default(false)
  image         String? //@db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  role ROLE @default(USER)

  businessId String?
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  inventoryHistory InventoryHistory[]
  customers        Customer[]

  @@unique([email, businessId]) // Same email can exist across different businesses
  @@index([businessId])
  @@map("user")
}

model SignupToken {
  token      String   @unique
  userId     String
  businessId String
  expiresAt  DateTime // 5 minutes
  used       Boolean  @default(false)
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String? //@db.Text
  userAgent String? //@db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String //@db.Text
  providerId            String //@db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String? //@db.Text
  refreshToken          String? //@db.Text
  idToken               String? //@db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String? //@db.Text
  password              String? //@db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String //@db.Text
  value      String //@db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

enum BusinessDomainStatus {
  NONE
  PENDING_DNS
  ACTIVE
}

model Business {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Identity
  name         String
  slug         String               @unique // URL-friendly version of name
  subdomain    String               @unique // "anothershop" for anothershop.myapplication.com
  customDomain String?              @unique // "anothershop.co"
  domainStatus BusinessDomainStatus @default(NONE) // none | pending_dns | active

  // Template & Branding
  templateId String @default("modern") // modern | vintage | minimal

  // Contact & Legal
  ownerEmail      String
  supportEmail    String?
  businessAddress String?
  taxId           String? // For tax purposes

  // Integrations
  stripeAccountId String? @unique // Stripe Connect account ID

  // Analytics
  umamiWebsiteId String? // Each business gets their own website ID
  umamiEnabled   Boolean @default(false)

  // Status
  status             String  @default("active") // active | suspended | closed
  onboardingComplete Boolean @default(false)

  // Relationships
  users              User[]
  products           Product[]
  collections        Collection[]
  orders             Order[]
  customers          Customer[]
  siteContent        SiteContent?
  images             Image[]
  discountCodes      DiscountCode[]
  inventoryHistory   InventoryHistory[]
  pages              Page[]
  productImports     ProductImport[]
  galleries          Gallery[]
  testimonials       Testimonial[]
  testimonialInvites TestimonialInvite[]

  @@index([subdomain])
  @@index([customDomain])
}

model SiteContent {
  id        String   @id @default(cuid())
  updatedAt DateTime @updatedAt

  // Hero Section
  heroTitle      String?
  heroSubtitle   String?
  heroImageUrl   String?
  heroButtonText String?
  heroButtonLink String?

  // About Section
  aboutTitle    String?
  aboutText     String? @db.Text
  aboutImageUrl String?

  // Features (stored as JSON for flexibility)
  features Json? // [{ title, description, icon }]

  // Footer
  footerText  String?
  socialLinks Json? // { instagram, facebook, twitter }

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  ogImage         String?
  faviconUrl      String?

  // Logo
  logoUrl     String?
  logoAltText String?

  // Colors & Styling (template customization)
  primaryColor   String? @default("#000000")
  secondaryColor String? @default("#ffffff")
  accentColor    String? @default("#3b82f6")

  // Navigation (custom menu items)
  navigationItems Json? // [{ label, href }]

  //Misc Business Information
  customFields Json? // { key: value }

  // One-to-one with Business
  businessId String   @unique
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Product {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  name        String
  slug        String // URL-friendly, unique per business
  description String? @db.Text

  // Pricing
  price          Float // Base price in cents or dollars
  compareAtPrice Float? // Original price for "sale" display
  cost           Float? // Cost to business (for profit tracking)

  // Inventory
  sku             String?
  barcode         String?
  trackInventory  Boolean @default(false)
  inventoryQty    Int     @default(0)
  allowBackorders Boolean @default(false)

  // Physical attributes
  weight     Float? // in lbs or kg
  weightUnit String? @default("lb") // lb | kg

  // Organization
  published Boolean @default(false)
  featured  Boolean @default(false)
  sortOrder Int     @default(0)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Multi-tenancy
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Relationships
  images             Image[]
  variants           ProductVariant[]
  collectionProducts CollectionProduct[]
  orderItems         OrderItem[]
  inventoryHistory   InventoryHistory[]

  @@unique([businessId, slug])
  @@index([businessId, published])
  @@index([businessId, featured])
}

model ProductVariant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Variant details
  name    String // e.g., "Small / Red"
  sku     String?
  barcode String?

  // Pricing (overrides product price if set)
  price          Float?
  compareAtPrice Float?

  // Inventory
  inventoryQty Int @default(0)

  // Options (stored as JSON for flexibility)
  options Json // { size: "Small", color: "Red" }

  // Image
  imageUrl String?

  // Relationships
  productId        String
  product          Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryHistory InventoryHistory[]
  orderItems       OrderItem[]

  @@index([productId])
}

model Collection {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  slug        String
  description String? @db.Text
  imageUrl    String?

  published Boolean @default(true)
  sortOrder Int     @default(0)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Multi-tenancy
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  collectionProducts CollectionProduct[]

  @@unique([businessId, slug])
  @@index([businessId])
}

model CollectionProduct {
  id        String @id @default(cuid())
  sortOrder Int    @default(0)

  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
  @@index([collectionId])
  @@index([productId])
}

model Image {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  url       String
  altText   String?
  width     Int?
  height    Int?
  sortOrder Int     @default(0)

  // What this image is for
  productId  String?
  businessId String?

  product  Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  business Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([businessId])
}

model Customer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email     String
  firstName String?
  lastName  String?
  phone     String?

  // Marketing
  acceptsMarketing Boolean @default(false)

  // Stats
  totalSpent Float @default(0)
  orderCount Int   @default(0)

  // Link to authenticated user (if they've signed in)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Multi-tenancy (customer exists per business)
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  orders             Order[]
  shippingAddresses  ShippingAddress[]
  testimonials       Testimonial[]
  testimonialInvites TestimonialInvite[]

  @@unique([businessId, email])
  @@index([businessId])
  @@index([userId])
}

model ShippingAddress {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  firstName String
  lastName  String
  company   String?
  address1  String
  address2  String?
  city      String
  province  String? // State/Province
  country   String
  zip       String
  phone     String?

  isDefault Boolean @default(false)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  orders Order[]

  @@index([customerId])
}

model Order {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Order number (human-readable, e.g., #1001)
  orderNumber Int

  // Status
  status            String @default("pending") // pending | paid | fulfilled | cancelled | refunded
  paymentStatus     String @default("pending") // pending | paid | failed | refunded
  fulfillmentStatus String @default("unfulfilled") // unfulfilled | fulfilled | partially_fulfilled

  // Stripe
  stripeSessionId       String? @unique
  stripePaymentIntentId String?

  // Pricing (in cents)
  subtotal Int
  tax      Int @default(0)
  shipping Int @default(0)
  discount Int @default(0)
  total    Int

  // Customer info (denormalized for historical record)
  customerEmail     String
  customerName      String? // For simpler storage (combines first+last)
  customerFirstName String?
  customerLastName  String?
  customerPhone     String?

  // Shipping (direct fields for webhook/manual orders)
  // shippingName    String?
  // shippingAddress String? @db.Text // JSON string for simple address storage
  trackingNumber String?
  trackingUrl    String?
  shippedAt      DateTime?

  // Notes
  customerNote String? @db.Text
  internalNote String? @db.Text

  // Multi-tenancy
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  shippingAddressId String?
  shippingAddress   ShippingAddress? @relation(fields: [shippingAddressId], references: [id], onDelete: SetNull)

  discountCodeId String?
  discountCode   DiscountCode? @relation(fields: [discountCodeId], references: [id], onDelete: SetNull)

  items            OrderItem[]
  inventoryHistory InventoryHistory[]

  @@unique([businessId, orderNumber])
  @@index([businessId, status])
  @@index([businessId, createdAt])
  @@index([customerId])
}

model OrderItem {
  id String @id @default(cuid())

  // Product info (snapshot at time of order)
  productName String
  variantName String?
  sku         String?

  // Pricing (snapshot)
  price    Float
  quantity Int
  total    Float // price * quantity

  // Relationships (nullable in case product is deleted)
  productId        String?
  productVariantId String?

  product        Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id], onDelete: SetNull)

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
}

// For tracking which domains need to be added to Coolify
model DomainQueue {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  domain     String @unique
  businessId String
  status     String @default("pending") // pending | processing | completed | failed

  attempts  Int     @default(0)
  lastError String?

  @@index([status])
}

// Analytics (optional - could also use external service)
model PageView {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  path      String
  referrer  String?
  userAgent String?
  ipAddress String?

  businessId String

  @@index([businessId, createdAt])
  @@index([createdAt])
}

// ============================================
// DISCOUNTS & PROMOTIONS
// ============================================

model DiscountCode {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Code details
  code  String // "SUMMER20", "SAVE10"
  type  String // "percentage" | "fixed"
  value Int // 20 (for 20%) or 1000 (for $10 in cents)

  // Status
  active Boolean @default(true)

  // Usage limits
  usageLimit Int? // null = unlimited
  usageCount Int  @default(0)

  // Validity period
  startsAt  DateTime?
  expiresAt DateTime?

  // Restrictions (future enhancements)
  minPurchase Int? // minimum order value in cents
  maxDiscount Int? // cap discount amount in cents

  // Relationships
  orders Order[]

  @@unique([businessId, code])
  @@index([businessId])
  @@index([businessId, active])
  @@index([code])
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model InventoryHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // What changed
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Quantity changes
  previousQty Int
  newQty      Int
  changeQty   Int // positive = increase, negative = decrease

  // Why it changed
  reason String // "sale", "return", "restock", "adjustment", "correction", "damage"
  note   String? @db.Text

  // References
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([variantId])
  @@index([productId])
  @@index([businessId])
  @@index([orderId])
  @@index([createdAt])
}

model Page {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Page identity
  title   String
  slug    String // about, contact, privacy, terms, etc.
  content Json
  excerpt String? @db.Text

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  ogImage         String?

  // Status
  published Boolean @default(true)
  sortOrder Int     @default(0)

  // Page type
  type     String @default("page") // page | policy | custom
  template String @default("default") // default | sidebar | full-width

  // Relationships
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, slug])
  @@index([businessId, published])
  @@index([businessId, type])
}

model ProductImport {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Import metadata
  filename  String
  totalRows Int
  status    String @default("pending") // pending | processing | completed | failed

  // Mapping & validation
  mappedData Json // Parsed and mapped products
  errors     Json? // Validation errors
  warnings   Json? // Non-critical issues

  // Results
  importedCount Int @default(0)
  skippedCount  Int @default(0)
  errorCount    Int @default(0)

  // Business
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdById String

  @@index([businessId])
  @@index([status])
}

model Gallery {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Identity
  name        String
  slug        String
  description String?

  // Layout
  layout String @default("grid") // grid | masonry | carousel | collage | justified

  // Grid settings
  columns     Int     @default(3) // 2, 3, 4, 5
  gap         Int     @default(16) // Gap between images in px
  aspectRatio String? @default("1:1") // 1:1, 4:3, 16:9, auto

  // Display settings
  showCaptions   Boolean @default(true)
  enableLightbox Boolean @default(true)

  // Multi-tenancy
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Relationships
  images GalleryImage[]

  @@unique([businessId, slug])
  @@index([businessId])
}

model GalleryImage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Image data
  url     String
  altText String?
  caption String?
  width   Int?
  height  Int?

  // Ordering
  sortOrder Int @default(0)

  // Relationships
  galleryId String
  gallery   Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@index([galleryId, sortOrder])
}

model Testimonial {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Content
  rating   Int // 1-5 stars
  text     String  @db.Text
  videoUrl String? // Optional video URL
  photoUrl String? // Optional photo URL

  // Status
  isPublic Boolean @default(false) // Owner approval

  // Customer info (captured at submission)
  customerName  String
  customerEmail String

  // Relationships
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@unique([businessId, customerEmail]) // One testimonial per customer per business
  @@index([businessId, isPublic])
  @@index([customerId])
}

model TestimonialInvite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  expiresAt DateTime

  // Invite details
  email  String
  code   String    @unique // Unique code for URL
  used   Boolean   @default(false)
  usedAt DateTime?

  // Relationships
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  customerId String? // If inviting existing customer
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([code])
  @@index([email])
}
